const E=(e,n)=>n.some(t=>e instanceof t);let B,b;function M(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function L(){return b||(b=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const l=new WeakMap,f=new WeakMap,p=new WeakMap,h=new WeakMap,D=new WeakMap;function g(e){const n=new Promise((t,o)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",r)},i=()=>{t(a(e.result)),s()},r=()=>{o(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",r)});return n.then(t=>{t instanceof IDBCursor&&l.set(t,e)}).catch(()=>{}),D.set(n,e),n}function P(e){if(f.has(e))return;const n=new Promise((t,o)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",r),e.removeEventListener("abort",r)},i=()=>{t(),s()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",r),e.addEventListener("abort",r)});f.set(e,n)}let m={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return f.get(e);if(n==="objectStoreNames")return e.objectStoreNames||p.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return a(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function C(e){m=e(m)}function S(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){const o=e.call(y(this),n,...t);return p.set(o,n.sort?n.sort():[n]),a(o)}:L().includes(e)?function(...n){return e.apply(y(this),n),a(l.get(this))}:function(...n){return a(e.apply(y(this),n))}}function T(e){return typeof e=="function"?S(e):(e instanceof IDBTransaction&&P(e),E(e,M())?new Proxy(e,m):e)}function a(e){if(e instanceof IDBRequest)return g(e);if(h.has(e))return h.get(e);const n=T(e);return n!==e&&(h.set(e,n),D.set(n,e)),n}const y=e=>D.get(e);function A(e,n,{blocked:t,upgrade:o,blocking:s,terminated:i}={}){const r=indexedDB.open(e,n),u=a(r);return o&&r.addEventListener("upgradeneeded",c=>{o(a(r.result),c.oldVersion,c.newVersion,a(r.transaction))}),t&&r.addEventListener("blocked",()=>t()),u.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",()=>s())}).catch(()=>{}),u}const j=["get","getKey","getAll","getAllKeys","count"],v=["put","add","delete","clear"],I=new Map;function w(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(I.get(n))return I.get(n);const t=n.replace(/FromIndex$/,""),o=n!==t,s=v.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(s||j.includes(t)))return;const i=async function(r,...u){const c=this.transaction(r,s?"readwrite":"readonly");let d=c.store;return o&&(d=d.index(u.shift())),(await Promise.all([d[t](...u),s&&c.done]))[0]};return I.set(n,i),i}C(e=>({...e,get:(n,t,o)=>w(n,t)||e.get(n,t,o),has:(n,t)=>!!w(n,t)||e.has(n,t)}));export{A as o};
